# **Highway Driving Project**

The goal of this project is to safely navigate around a virtual highway with other traffic under certain boundary conditions.

There are potential shortcomings with the current approach, which are identified, and methods to address them are also elaborated in this document.

## Boundary Conditions

The following boundary conditions needs to be satisfied when driving around the highway.

1. The car should try to go as close as possible to the 50 MPH speed limit, which means passing slower traffic when possible, note that other cars will try to change lanes too.

2. The car should avoid hitting other cars at all cost as well as driving inside of the marked road lanes at all times, unless going from one lane to another.

3. The car should be able to make one complete loop around the 6946m highway.

4. Also the car should not experience total acceleration over 10 m/s^2 and jerk that is greater than 10 m/s^3.

[//]: # (Image References)

[image1]: ./writeup_images/theory.png "Therotical background"
[image2]: ./writeup_images/fsm.png "Finite State Machine"


## Available Data

The following data are available for the ego vehicle from the simulator:

* **Highway Map**: The map of the highway is provided in the data/highway_map.txt. Each waypoint in the list contains  [x,y,s,dx,dy] values.

* **Localization data**: For each update cycle of the simulator, the localization data of the ego car and other vehicles in the environment is provided.

* **Previous trajectory**: The part of trajectory from the previous trajectory which has not been utilized during the update cycle is given as previous trajectory at the beginning of each update cycle.


## Theoritical Background

Let us have a brief overview of the theory behind the highway driving project before going into the details of implementation.

The above figure enlists some of the components/modules which are essential for driving a car in a highway [1]. The flow of data through these modules is also described in the figure.

![alt text][image1]


**Motion Control**: This module dictates how a vehicle should move to the next point in the real world.

**Sensor Fusion**: This module is necessary to get data and understand the current environment using the different sensors available in the car.

**Localization**: This module localizes a vehicle within a specific environment i.e. where the vehicle is currently present/located within the environment.

**Trajectory**: This module is reponsible for generating trajectories that a vehicle should take.

**Prediction**: This module is used to predict the position of the other vehicles (in the traffic) in the immediate future.

**Behavior**: This module determines the behavior of a vehicle (such as lane changes, breaking, accelerating, etc.) depending on the environmental conditions.


## Implementation of the project

### Trajectory Generator

The trajectory generation is carried out in the class named ```TrajectoryGenerator```. The primary goal of this class is to generate a trajectory for a given state. The generation of the trajectoy is done in Frenet co-ordinates and is based on JMT. The trajectory is generated by appending new points to previous trajectory. This technique of using part of previous trajectory prevents abrupt changes in acceleration and jerk.


### Jerk Minimizing Technique

Acceleration and jerk can be defined as rate of change of velocity and acceleration respectively. These play an important role in the comfort of the passengers and therefore it is limited to 10 m/s and 10 m/s^2 respectively in this project.

A quintic polynomial solver which reduces jerk by eliminating higher degree polynomials (greater than six degrees) is used to create jerk minimized trajectories. This technique is implemented in the class ```JMT```.


### Prediction

The prediction module is essential to identify a collision course of the ego vehicle with other vehicles in the environment or vice-versa. In the project, a simple motion model (velocity-time-direction) is used to predict the other vehicles in future. This is implemented as part of the function ```CollisionInfo check_collision(const Vehicle &vehicle, double timestep, double threshold) const``` in the class ```Trajectory```.


### Behavior

The behavior module should decide what the ego vehicle should do in the immediate future. The behavior module is implemented in the class ```VehicleBehaviour```.

In the project, the behavior of the car is mainly dependent on two main factors namely **Finite State Machine** and **Cost Functions**. 


#### Finite State Machine (FSM)

FSM shows the possible states that are available for the vehicle at a given point in time. The FSM is implemented in the class ```FSM```. Some of the possible states for the ego vehicle are listed below. [2]

``` cpp
enum class LongitudinalState
{
    INIT = -1,
    ACCELERATE = 0,
    DECELERATE = 1,
    MAINTAIN = 2,
    HARD_DECELERATE = 3
};

enum class LateralState
{
    INIT = -1,
    KEEP_LANE = 0,
    PREPARE_CHANGE_LANE_LEFT = 1,
    PREPARE_CHANGE_LANE_RIGHT = 2,
    CHANGE_LANE_LEFT = 3,
    CHANGE_LANE_RIGHT = 4
};

```

A ego vehicle cannot visit all the possible states since some states can only be entered on certain pre-conditions. The FSM for ```LateralState``` is shown in the figure [1]. 

![alt text][image2]


#### Cost Functions

For each possible state, a trajectory is generated using the ```TrajectoryGenerator```. The behavior module makes its decision on which trajectory to select based on the cost of the trajectory. The lower the cost better the trajectory. The cost logic is implemented in the class ```CostEvaluator```

The cost functions helps to navigate the ego vehicle without violating the boundary conditions. For a given trajectory, the following costs contribute to the total cost.

1. If the maximum speed limit (50 MPH) is exceeded, the trajectory incurs a very high cost.

2. If the vehicle goes out of all available lanes, the trajectory incurs a very high cost.

3. If the maximum acceleration (10 m/s^2) is exceeded, the trajectory incurs a very high cost.

4. If there is an impending collision with a vehicle ahead, the trajectory incurs a very high cost.

5. If there is an impending collision with a vehicle in the rear and parallel during lane change, the trajectory incurs a very high cost.

6. Depending on the difference in the distance of our vehicle to the center of the lane, a cost is incurred. The higher the difference the higher is the cost. Our goal is to make the vehicle close to the center of the lane.

7. Depending on the distance of the ego vehicle to the vehicle ahead, a cost is incurred. The higher the difference the lesser is the cost. Our goal is to make the vehicle not too close to the vehicle ahead.

8. Depending on the difference in the speed of the ego vehicle to the maximum speed, a cost is incurred. The higher the difference the higher is the cost. Our goal is to make the vehicle travel at the maximum possible speed.

9. Depending on the difference of the average speed lane ( the future lane the vehicle is planning to take) to the maximum speed, a cost is incurred. The higher the difference the higher is the cost. Our goal is to make the vehicle travel in the fastest lane when possible.

10. Depending on the speed difference of the ego vehicle to the vehicle ahead, a cost is incurred. The higher the difference the higher is the cost. Our goal is to make the vehicle match the speed of the vehicle ahead.

11. Depending on the distance of the ego vehicle to the vehicle ahead, a cost is incurred. The higher the difference the lesser is the cost. Our goal is to make the vehicle not too close to the vehicle ahead.


### Discussion

The highway driving project is one of the challenging projects in the course due to the complexity of the problem in hand. Although we could solve the highway driving problem using cost functions as the basis for selection of trajectories, I doubt this could be useful for all driving scenarios. There are several reasons against cost functions,  some of which have been listed below.

* We could create so many new cost functions depending on new driving scenarios which makes the cost function technique as a kind of hard-coded algorithm.

* The fine tuning of weights for each cost function is difficult, since a change in weight for single cost function would lead to a failure of the entire system. 

* The introduction of new cost functions could also lead to the failure of the entire system.

* Once we have several cost functions, it would be impossible to debug the reason for the failure of the system if one occurs.


### Shortcoming identified and possible improvements to the project

* As already discussed, several new cost functions can be created since the ego vehicle does fail in some complex scenarios. This needs more debugging effort and fine tuning of weights.

* The given map waypoints have been smoothed by using the spline library. It has been noticed if the ego vehicle travels in the right most lane at 1.87 and 3.07 miles from the start, there is a incident named "Outside the lane". Visually the vehicle is within the lane bounds. On closer debugging, the d values are near the center of lane and no abnormalities have been seen. One reason that could be attributed to this behavior is the conversion from frenet co-ordinates to cartesion co-ordinates. One assumption is that this could be solved by having a closer waypoint in the given map but unfortunately I couldnt find the logic with which the waypoints are currently described.

* In the prediction module, currently we have used a simple motion model (velocity-time-direction) to predict the other vehicles in future. More complex models using probabilistic methods can also be employed to make accurate predictions.



### References:


[1] Udacity Coursework.

[2] Project description from a fellow student: https://towardsdatascience.com/teaching-cars-to-drive-highway-path-planning-109c49f9f86c.





